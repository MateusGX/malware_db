using System;
using System.Collections.Generic;
using System.Text;
using System.Threading;
using System.IO;
using System.Security.Cryptography;
namespace Malware_DB
{
    class Functions
    {
        public enum wType { Error, Info, Success, Default }
        public Config _config;
        public Functions(Config config)
        {
            _config = config;
        }
        public void showTitle()
        {
            Console.WriteLine(@"
 ███╗   ███╗ █████╗ ██╗     ██╗    ██╗ █████╗ ██████╗ ███████╗        ██████╗ ██████╗ 
 ████╗ ████║██╔══██╗██║     ██║    ██║██╔══██╗██╔══██╗██╔════╝        ██╔══██╗██╔══██╗
 ██╔████╔██║███████║██║     ██║ █╗ ██║███████║██████╔╝█████╗          ██║  ██║██████╔╝
 ██║╚██╔╝██║██╔══██║██║     ██║███╗██║██╔══██║██╔══██╗██╔══╝          ██║  ██║██╔══██╗
 ██║ ╚═╝ ██║██║  ██║███████╗╚███╔███╔╝██║  ██║██║  ██║███████╗███████╗██████╔╝██████╔╝
 ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝ ╚══╝╚══╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝╚═════╝ ╚═════╝ 
 by MateusGX
");
        }
        public string[] readLine()
        {
            Console.ForegroundColor = ConsoleColor.Red;
            Console.Write(" ╔═[");
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.Write(_config.user);
            Console.ForegroundColor = ConsoleColor.Red;
            Console.Write("]═[");
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.Write("~");
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine("]");
            Console.Write(" ╚═══>");
            Console.ResetColor();
            string input = Console.ReadLine();
            return input.Split(' ');
        }
        public bool runCommand(string[] command)
        {
            if (command[0] == "help")
            {
                writeLine("==== SYSTEM ====", wType.Success);
                writeLine("help", wType.Success, "List all commands");
                writeLine("clear", wType.Success, "Clear console");
                writeLine("exit", wType.Success, "Exit application", true);
                writeLine("==== APP ====", wType.Success);
                writeLine("show_all", wType.Success, "Show all malware");
                writeLine("select", wType.Success, "Select malware: select ID");
                writeLine("get_data", wType.Success, "Returns information about the malware");
                writeLine("update", wType.Success, "Updates the database and the application");
                writeLine("binaries", wType.Success, "Gets the executable of the selected malware (DANGER)");
                writeLine("source", wType.Success, "Gets the source code of the selected malware", true);
                return true;
            }
            else if (command[0] == "clear")
            {
                Console.Clear();
                Console.Write("\n");
                return true;
            }
            else if (command[0] == "exit")
            {
                writeLine("Bye!", wType.Success);
                Thread.Sleep(1000);
                Environment.Exit(0);
                return true;
            }
            else if (command[0] == "show_all")
            {
                Console.WriteLine(" ╔══════╦════════════════════════════════════════════════╦═══════════════╦════════════╦══════════════════╦══════════╗ ");
                Console.WriteLine(" ║  ID  ║                      NAME                      ║    VERSION    ║  PLATFORM  ║      AUTHOR      ║   DATE   ║ ");
                Console.WriteLine(" ╠══════╬════════════════════════════════════════════════╬═══════════════╬════════════╬══════════════════╬══════════╣ ");
                for (int i = 0; i < _config.mw.Count; i++)
                {
                    string id = i.ToString();
                    while (id.Length < 4)
                    {
                        id = "0" + id;
                    }
                    string name = String.Format("{0,-48}", _config.mw[i].Name);
                    string version, platform, author = "NA";
                    if (_config.mw[i].Version.Length > 15)
                    {
                        version = String.Format("{0,-15}", (_config.mw[i].Version.Substring(0, 12)+"..."));
                    }
                    else
                    {
                        version = String.Format("{0,-15}", _config.mw[i].Version);
                    }
                    if (_config.mw[i].Version.Length > 12)
                    {
                        platform = String.Format("{0,-12}", (_config.mw[i].Version.Substring(0, 9)+"..."));
                    }
                    else
                    {
                        platform = String.Format("{0,-12}", _config.mw[i].Version);
                    }
                    if (_config.mw[i].Version.Length > 18)
                    {
                        author = String.Format("{0,-18}", (_config.mw[i].Version.Substring(0, 15)+"..."));
                    }
                    else
                    {
                        author = String.Format("{0,-18}", _config.mw[i].Version);
                    }
                    string date = String.Format("{0,-10}", _config.mw[i].Date);
                    //Console.WriteLine(" ╔══════╦════════════════════════════════════════════════╦═══════════════╦════════════╦══════════════════╦══════════╗ ");
                    Console.WriteLine(" ║ " + id + " ║" + name + "║" + version + "║" + platform + "║" + author + "║" + date + "║ ");
                    if ((_config.mw.Count-1) == i)
                    {
                        Console.WriteLine(" ╚══════╩════════════════════════════════════════════════╩═══════════════╩════════════╩══════════════════╩══════════╝ ");
                    }
                    else
                    {
                        Console.WriteLine(" ╠══════╬════════════════════════════════════════════════╬═══════════════╬════════════╬══════════════════╬══════════╣ ");
                    }
                  
                }
                return true;
            }
            else if (command[0] == "select")
            {
                return true;
            }
            else if (command[0] == "get_data")
            {
                return true;
            }
            else if (command[0] == "update")
            {
                return true;
            }
            else if (command[0] == "binaries")
            {
                return true;
            }
            else if (command[0] == "source")
            {
                return true;
            }
            return false;
        }
        public void writeLine(string content, wType type, string info = "", bool lb = false)
        {
            if (type == wType.Error)
            {
                Console.ForegroundColor = ConsoleColor.Red;
            }
            else if (type == wType.Info)
            {
                Console.ForegroundColor = ConsoleColor.Cyan;
            }
            else if (type == wType.Success)
            {
                Console.ForegroundColor = ConsoleColor.Yellow;
            }
            else if (type == wType.Default)
            {
                Console.ForegroundColor = ConsoleColor.White;
            }
            Console.WriteLine(" " + content);
            if (info != "")
            {
                Console.ForegroundColor = ConsoleColor.Cyan;
                Console.Write("   " + info);
            }
            if (lb)
            {
                Console.Write("\n\n");
            }
            else
            {
                Console.Write("\n");
            }
            Console.ResetColor();
        }
        public void progress(int _progress)
        {
            Console.Write(" Loading...\n [");
            for (int i = 0; i < _progress; i++)
            {
                Console.Write("#");
            }
            Console.Write("] - " + _progress + "%\n");
        }
        public string decrypt(byte[] data, bool content = false)
        {
            string result;
            if (!content)
            {
                using (AesManaged aes = new AesManaged())
                {
                    aes.Key = _config.mwKey;
                    aes.IV = _config.mwIV;
                    ICryptoTransform decryptor = aes.CreateDecryptor(aes.Key, aes.IV);
                    using(MemoryStream ms = new MemoryStream(data))
                    {
                        using(CryptoStream cs = new CryptoStream(ms, decryptor, CryptoStreamMode.Read))
                        {
                            using(StreamReader sr = new StreamReader(cs))
                            {
                                result = sr.ReadToEnd();
                            }
                        }
                    }
                }
            }
            else
            {
                using (AesManaged aes = new AesManaged())
                {
                    aes.Key = _config.contentKey;
                    aes.IV = _config.contentIV;
                    ICryptoTransform decryptor = aes.CreateDecryptor(aes.Key, aes.IV);
                    using (MemoryStream ms = new MemoryStream(data))
                    {
                        using (CryptoStream cs = new CryptoStream(ms, decryptor, CryptoStreamMode.Read))
                        {
                            using (StreamReader sr = new StreamReader(cs,Encoding.UTF8))
                            {
                                result = sr.ReadToEnd();
                            }
                        }
                    }
                }
            }
            return result;
        }
    }
}
